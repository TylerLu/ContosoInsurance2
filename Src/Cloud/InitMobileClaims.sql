DECLARE @CurrentMigration [nvarchar](max)

IF object_id('[dbo].[__MigrationHistory]') IS NOT NULL
    SELECT @CurrentMigration =
        (SELECT TOP (1) 
        [Project1].[MigrationId] AS [MigrationId]
        FROM ( SELECT 
        [Extent1].[MigrationId] AS [MigrationId]
        FROM [dbo].[__MigrationHistory] AS [Extent1]
        WHERE [Extent1].[ContextKey] = N'ContosoInsurance.Common.Data.Migrations.MobileClaimsConfiguration'
        )  AS [Project1]
        ORDER BY [Project1].[MigrationId] DESC)

IF @CurrentMigration IS NULL
    SET @CurrentMigration = '0'

IF @CurrentMigration < '201609200107591_AutomaticMigration'
BEGIN
    CREATE TABLE [dbo].[Claims] (
        [Id] [nvarchar](128) NOT NULL DEFAULT NEWID(),
        [UserId] [nvarchar](255),
        [VehicleId] [int] NOT NULL,
        [DateTime] [datetime] NOT NULL,
        [Coordinates] [geography],
        [OtherPartyMobilePhone] [nvarchar](max),
        [Description] [nvarchar](max),
        [Version] rowversion NOT NULL,
        [CreatedAt] [datetimeoffset](7) NOT NULL DEFAULT SYSUTCDATETIME(),
        [UpdatedAt] [datetimeoffset](7),
        [Deleted] [bit] NOT NULL,
        CONSTRAINT [PK_dbo.Claims] PRIMARY KEY NONCLUSTERED ([Id])
    )
    CREATE TABLE [dbo].[CustomerVehicles] (
        [Id] [nvarchar](128) NOT NULL DEFAULT NEWID(),
        [UserId] [nvarchar](max),
        [LicensePlate] [nvarchar](max),
        [VIN] [nvarchar](max),
        [VehicleId] [int] NOT NULL,
        [Version] rowversion NOT NULL,
        [CreatedAt] [datetimeoffset](7) NOT NULL DEFAULT SYSUTCDATETIME(),
        [UpdatedAt] [datetimeoffset](7),
        [Deleted] [bit] NOT NULL,
        CONSTRAINT [PK_dbo.CustomerVehicles] PRIMARY KEY NONCLUSTERED ([Id])
    )
    CREATE CLUSTERED INDEX [IX_CreatedAt] ON [dbo].[Claims]([CreatedAt])
    CREATE CLUSTERED INDEX [IX_CreatedAt] ON [dbo].[CustomerVehicles]([CreatedAt])
    CREATE TABLE [dbo].[__MigrationHistory] (
        [MigrationId] [nvarchar](150) NOT NULL,
        [ContextKey] [nvarchar](300) NOT NULL,
        [Model] [varbinary](max) NOT NULL,
        [ProductVersion] [nvarchar](32) NOT NULL,
        CONSTRAINT [PK_dbo.__MigrationHistory] PRIMARY KEY ([MigrationId], [ContextKey])
    )
    INSERT [dbo].[__MigrationHistory]([MigrationId], [ContextKey], [Model], [ProductVersion])
    VALUES (N'201609200107591_AutomaticMigration', N'ContosoInsurance.Common.Data.Migrations.MobileClaimsConfiguration',  0x1F8B0800000000000400ED5A5F6FDB36107F1FB0EF20E869035ACB71D6AE0DEC16A9D314C6EAC4A8D2BED3D2D92646911A49A536867DB23DEC23ED2BECA8FF9225474ADCAE40F31691BCDFFDE1DDF1EE9C7FFFFE67FC7A1B30EB16A4A2824FEC93C1D0B6807BC2A77C3DB123BD7AFAC27EFDEAC71FC66FFD606B7DCACE9D9A7348C9D5C4DE681D9E398EF23610103508A82785122B3DF044E0105F38A3E1F0A57372E20042D8886559E30F11D73480F8033FA7827B10EA88B0B9F081A9741D77DC18D5BA2201A8907830B1F1AC46FC195791244836988A20107C70413419CCC59232B0AD7346098AE6025BD916E15C68A251F0B38F0A5C2D055FBB212E1076B30B01CFAD0853902A74561CEFAADB706474730AC20CCA8B9416414FC093D3D4584E9DFC5E26B77363A239DFA2D9F5CE681D9B14ADC9080D6CABCEE96CCAA439D5C9DC8318E489D572F449EE36E85D83E727C3E783D317C35F5E2241C4742461C221D292B027D6225A32EAFD06BB1BF13BF0098F182B8B8F0AE05E65019716528420F5EE03AC52A566BE6D39553AA74E98939568128DD141D0F96D6B4EB6EF81AFF506C362F4C2B62EE916FC6C25F5988F9C62AC209196117E5EA1C064C920DF770EF2446F9407F98E9E3DEBC4F7309B4FB0A11E8382D38CEBD3516F69F1C6E10683364329BE7B024D8590985F905C6558EF40AC250937BBBB68AFF506E482E042E27B8B8DE070C082F8E7112C7801CA93344C62F00BF34A8325E3F3060D25D12C26454652626EDECD63AC9851857F8B8FEEDD4E29CC5D2D24BC030E126FC35F10AD41727343411869D80FA3FA4D4A3074E7BAEE13D7AB95027D2FDE331FE2247567F084FE61DEC753F30218C4C7D22B118201E177F8FDD82992EDC1149C86E74393700AF398868F9F868F13D8EFA9075CC182A10F7EF92C32BBFA0A99EA28EFCA63C2FB1E129EC94A84A240E5C2535D2CCD3A6C7543F6C3B04C13A04AFDB12A7382EB82AE20DA562145D2000CD21AD7394C9E7A7313409EA19BD4CD152B9A1627E95AB2EEC669696FC6731286189AA576275DB1DCB4D779EAF6AFF98304C3F15443E99F4B9B73424F216BA8ED1A57F1E1924AA5CD1BB324E6B2A77EB07FAC768D2D36CEB8556EAAFE821476CF8E9BBFB39AB1631B52472D8C7A897A06186AB1CA908B96F5407B7471F74918910D4FD454B028E06DCFDC21EAECB12923646BDD514AA9B70C545AEE8E55D4F165A862B53B52A5B02F835536BAE3B514FB65E496233DB42F97F615039437FADC4CFA9A55EF255DEC61CBE2A5A958B258EEE173C5CB5171BB62B98FBDD2A7A16AAB74711F67ECD4C2AF1EF5CE5ED8D74AC67A12E99462F26C7EEC2493BD05FDD34C2BE5B79C68AA456B19ABBAD323404C655A090EB3F0FFA4BEC760ADA17CC960DD2B98EA4772EE79E1542B90C669B1D265485CAB5E9223B68506BAA5BEA95CDC9DD21024B1EDFEC1A68CA2BEC58139E174054A272DB03D1A9E8C6A63E56F67C4EB28E5B32E73DEAFDEC4F35B22BD0D910DE5BD0BF21653C88DE92712F74C08EBFDFE839AF9827F7DAA5AC0DEABD5A5BCA9D9EB37403501AD8F34405D1703D47E9A1D1CA866E6FB2920DB9FFB22370C4D1F84579B1348F1F9365BE9E45C39FD9DCD71DFEBA80F05B28B156963BE27DE8CFBB09DD87F5A333565B80912FC33EB068D60FDD5519B12D385048F26BFCBFDDAAA5D3165E81B50F5B1C39DDA35895B42E9246ED3657473BACAE46249BB0A98131E77A8FBDD66DC7B8578D388F46139A318833E30F71C21FF3F26B0C704F66D27B0BD21EDDE10B0C308B67D029B14E178014B81FA25326653DB6ED3D943C3D946F4D872208BE1EE3D47B8FB9DC7D829FF13CB18AB1DBA2E20CCBFB470F0CC6D15A0D999195F89ECDA51C5B244D9919A57CC4113F43F722E355D114FE3B6074AC5BFEB7C222CC2236F8325F8337E1D69F4BB73A52058B2CA6F0A63E730FF784E5D95797C1D976FEA182AA098D484D0357F1351E6E7725F3638690B8471C734D2502A579B885BEF72A4ABBDD15F1B506ABE0B08819BB472034168DE1C75CD5D720BF7910D5FC1F7B026DE2E6B20DB41EEBE88AAD9C7179460711FA814A3A0C74FF4613FD8BEFA0F8DBEF389CB250000 , N'6.1.3-40302')
END
GO
CREATE TRIGGER [TR_dbo_Claims_InsertUpdateDelete] ON [dbo].[Claims] AFTER INSERT, UPDATE, DELETE AS BEGIN UPDATE [dbo].[Claims] SET [dbo].[Claims].[UpdatedAt] = CONVERT(DATETIMEOFFSET, SYSUTCDATETIME()) FROM INSERTED WHERE inserted.[Id] = [dbo].[Claims].[Id] END
GO
CREATE TRIGGER [TR_dbo_CustomerVehicles_InsertUpdateDelete] ON [dbo].[CustomerVehicles] AFTER INSERT, UPDATE, DELETE AS BEGIN UPDATE [dbo].[CustomerVehicles] SET [dbo].[CustomerVehicles].[UpdatedAt] = CONVERT(DATETIMEOFFSET, SYSUTCDATETIME()) FROM INSERTED WHERE inserted.[Id] = [dbo].[CustomerVehicles].[Id] END
GO